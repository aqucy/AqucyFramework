<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8">
    <title></title>
    <link rel="stylesheet" type="text/css" href="/js/ext/resources/css/ext-all.css"/>
    <link rel="stylesheet" type="text/css" href="/js/ext/resources/css/xtheme-gray.css"/>
    <link rel="stylesheet" type="text/css" href="/css/icon.css"/>
    <script type="text/javascript" src="/js/ext/adapter/ext/ext-base.js"></script>
    <script type="text/javascript" src="/js/ext/ext-all.js"></script>
    <script type="text/javascript" src="/js/ext/source/locale/ext-lang-zh_CN.js"></script>
    <script type="text/javascript">
        Ext.onReady(function () {
            Ext.BLANK_IMAGE_URL = "/js/ext/resources/images/default/s.gif";
            Ext.QuickTips.init();
            Ext.form.Field.prototype.msgTarget = "qtip";//side:右侧 under:下方  id: [element id]错误提示显示在指定id的HTML元件中 qtip:鼠标移动到组件时显示
            var opUrl = "/systemManager/userManager";
            var delUrl = opUrl;
            var viewUrl = opUrl;
            var addurl = opUrl;
            var editUrl = opUrl;
            var dictUrl = "/getDict?code=";
            var loadMarsk = new Ext.LoadMask(document.body, {
                msg: '正在加载数据，请稍候......',
                removeMask: true// 完成后移除
            });
/////////////////////////字典匹配////////////////////////////////////////////////////
            function renderSex(value) {
                if (value == '1') {
                    return "男";
                } else {
                    return "女";
                }
            }

            function renderStatus(value) {
                if (value == "1") {
                    return "已激活";
                } else if (value == "0") {
                    return "未激活";
                } else if (value == "2") {
                    return "已注销";
                }
            }

///////////////////////////Store区///////////////////////////////////
            var store_grid = new Ext.data.JsonStore({
                url: viewUrl+'?op=view', //后缀名为json的文件
                totalProperty: "totalCount",
                root: 'datas',     //读取里面的users对象
                fields: ['username', 'userRealName', 'sex', 'status', 'password', 'QQ', 'mail', 'mobile', 'phone', 'create_time',] //读取里面的属性
            });

            var store_status = new Ext.data.JsonStore({
                url: dictUrl+'acyframework_users_status',
                root: 'datas',
                fields: ['label', 'value']
            });

            var store_sex = new Ext.data.JsonStore({
                url: dictUrl+'acyframework_users_sex',
                root: 'datas',
                fields: ['label', 'value']
            });


            //定义勾选框，不需要可不必定义
            var sm = new Ext.grid.CheckboxSelectionModel();
            //定义列,在这里定义每列的宽度
            var colM = new Ext.grid.ColumnModel([
                new Ext.grid.RowNumberer(),//增加自动编号，不需要可不必定义
                sm,//勾选框，不需要可不必定义
                {header: '登录名', dataIndex: 'username', width: 170, sortable: true},// 生成列，sortable为列排序，不需要设置为false，默认false，renderer为该列增加自定义函数
                {header: '姓名', dataIndex: 'userRealName', width: 90}, // sortable进行排序
                {header: '性别', dataIndex: 'sex', width: 50, renderer: renderSex},
                {header: '状态', dataIndex: 'status', width: 70, renderer: renderStatus},
                {header: '创建时间', dataIndex: 'create_time', width: 170},
                {header: '手机', dataIndex: 'mobile', width: 170},
                {header: '固话', dataIndex: 'phone', width: 170},
                {header: '邮箱', dataIndex: 'mail', width: 170},
                {header: 'QQ', dataIndex: 'QQ', width: 170},
                {header: '最后登录', dataIndex: 'lastLoginDate', width: 170}
            ]);

            //生成表格
            var grid = new Ext.grid.GridPanel({
                loadMask: {
                    msg: '数据加载中，请稍候...'
                },
                cm: colM,
                sm: sm,
                store: store_grid,
                viewConfig: {
                    forceFit: true
                },
                tbar: [
                    {
                        text: "添加",
                        iconCls: "add",
                        handler: function (e) {
                            add();
                        }
                    },
                    {
                        text: "修改",
                        iconCls: "pageedit",
                        handler: function (e) {
                            edit();
                        }
                    },
                    {
                        text: "删除",
                        iconCls: "delete",
                        handler:function(e){
                            del();
                        }
                    }
                ],
                bbar: new Ext.PagingToolbar({
                    pageSize: 3,
                    store: store_grid,
                    displayInfo: true,
                    displayMsg: '显示第{0}条到{1}条记录,一共{2}条',
                    emptyMsg: '没有记录'
                })
            });
            grid.on("rowdblclick", function (datagrid, row) {
                edit();
            });
            grid.on("rowcontextmenu", function (grid, rowIndex, e) {
                if (rowIndex < 0) {
                    return;
                }
                e.preventDefault();
                var allowEdit = true;
                var selArr = grid.getSelectionModel().getSelections();
                if (selArr.length <= 1) {
                    //选中行
                    grid.getSelectionModel().selectRow(rowIndex,false);
                } else if (selArr.length > 1) {
                    allowEdit = false;
                }

                var menus = new Ext.menu.Menu
                ({
                    items: [
                        {
                            text: "添加",
                            pressed: true,
                            iconCls: "leaf",
                            handler: function () {
                                add();
                                menus.destroy();
                            }
                        },
                        {
                            text: "编辑",
                            pressed: true,
                            disabled:!allowEdit,
                            iconCls: "leaf",
                            handler: function () {
                                edit();
                                menus.destroy();
                            }
                        },
                        {
                            text: "删除",
                            pressed: true,
                            iconCls: "leaf",
                            handler: function () {
                                del();
                                menus.destroy();
                            }
                        }
                    ]
                });
                menus.showAt(e.getPoint());
            });
            var viewport = new Ext.Viewport({
                layout: 'border',
                autoScroll: true,
                items: [{
                    region: 'center',
                    deferredRender: false,
                    bodyStyle: "overflow-y:hidden;overflow-x:auto",
                    items: grid,
                    autoScroll: true
                }]
            });
//////////////////////查询界面/////////////////////
            var query_form = new Ext.FormPanel({
                renderTo: grid.tbar,
                labelAlign: 'left',
                buttonAlign: 'right',
                border: false,
                frame: true,
                items: [
                    {
                        layout: 'table',
                        layoutConfig: {
                            columns: 4
                        },
                        border: false,
                        labelSeparator: ':',
                        defaults: {
                            layout: 'form',
                            labelWidth: 12 * 5,
                            bodyStyle: 'padding:0 0 0 20',
                            border: false
                        },
                        items: [
                            {
                                items: [
                                    {
                                        xtype: 'field',
                                        maxlength: 10,
                                        minLength: 2,
                                        name: "user.userRealName",
                                        fieldLabel: '姓名'
                                    },
                                    {
                                        xtype: 'hidden',
                                        name: "op",
                                        value: "view",
                                        fieldLabel: 'op'
                                    }
                                ]
                            }, {
                                items: [
                                    {
                                        xtype: "combo",
                                        fieldLabel: "状态",
                                        hiddenName: "user.status",
                                        name: "status",
                                        valueField: "value",
                                        displayField: "label",
                                        selectOnFocus: true,
                                        emptyText: "请选择...",
                                        mode: 'remote',
                                        forceSelection: true,
                                        triggerAction: 'all',
                                        width: 70,
                                        store: store_status,
                                        listeners: {
                                            select: function (combo, record, index) {

                                            },
                                            render: function (comb, record, index) {

                                            }
                                        }
                                    }
                                ]
                            }, {
                                items: [{
                                    xtype: "combo",
                                    fieldLabel: "性别",
                                    name: "sex",
                                    hiddenName: "user.sex",
                                    blankText: "不能为空，请填写",
                                    valueField: "value",
                                    displayField: "label",
                                    emptyText: "请选择...",
                                    mode: 'remote',
                                    forceSelection: true,
                                    triggerAction: 'all',
                                    width: 70,
                                    store: store_sex,
                                    listeners: {
                                        select: function (combo, record, index) {

                                        },
                                        render: function (comb, record, index) {

                                        }
                                    }
                                }]
                            }, {
                                items: [
                                    {
                                        xtype: 'field',
                                        maxlength: 15,
                                        minLength: 5,
                                        name: "user.QQ",
                                        fieldLabel: 'QQ号码'
                                    }
                                ]
                            }, {
                                items: [
                                    {
                                        xtype: 'field',
                                        maxlength: 255,
                                        minLength: 2,
                                        name: "user.address",
                                        fieldLabel: '地址'
                                    }
                                ]
                            }, {
                                layout: "table",
                                items: [
                                    {
                                        xtype: "button",
                                        text: "查询",
                                        iconCls: "accept",
                                        handler: function () {
                                            //表单提交
                                            query(query_form);
                                        }
                                    }, {
                                        xtype: "button",
                                        text: "重置",
                                        iconCls: "accept",
                                        handler: function () {
                                            //表单提交
                                            query_form.form.reset();
                                            query(query_form);
                                        }
                                    }
                                ]
                            }
                        ]
                    }
                ]//items
            })//FormPanel

            grid.setHeight(Ext.get("content").getHeight() - 5);
            store_grid.load();

//////////////////////编辑界面//////////////////////////////////////////
            function edit() {
                var selArr = grid.getSelectionModel().getSelections();
                if (selArr.length < 1) {
                    Ext.MessageBox.alert("", "请选择要编辑或修改的数据行!");
                    return;
                } else if (selArr.length > 1) {
                    Ext.MessageBox.alert("", "编辑或修改数据的时候不能多选!");
                    return;
                }
                json = selArr[0].json;
                var p = new Ext.FormPanel
                ({
                    frame: true, labelWidth: 12 * 5,
                    items: [
                        {
                            xtype: "hidden",
                            id: "id",
                            name: "user.id",
                            width: 201,
                            value: json.id
                        },
                        {
                            xtype: "hidden",
                            id: "op",
                            name: "op",
                            width: 201,
                            value: "edit"
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "登录ID",
                            id: "username",
                            name: "user.username",
                            allowBlank: false,
                            blankText: "不能为空，请填写",
                            value: json.username,
                            width: 201
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "密码",
                            id: "password",
                            name: "user.password",
                            allowBlank: false,
                            blankText: "不能为空，请填写",
                            value: json.password,
                            width: 201
                        },
                        {
                            xtype: "combo",
                            fieldLabel: "状态",
                            id: "status",
                            hiddenName: "user.status",
                            name: "status",
                            allowBlank: false,
                            valueField: "value",
                            displayField: "label",
                            selectOnFocus: true,
                            mode: 'remote',
                            forceSelection: true,
                            emptyText: "请选择...",
                            triggerAction: 'all',
                            width: 70,
                            store: store_status,
                            listeners: {
                                select: function (combo, record, index) {

                                },
                                render: function (comb, record, index) {

                                }
                            }
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "姓名",
                            id: "userRealName",
                            name: "user.userRealName",
                            allowBlank: false,
                            minLength: 2,
                            maxlength: 5,
                            value: json.userRealName,
                            width: 201
                        },
                        {
                            xtype: "combo",
                            fieldLabel: "性别",
                            id: "sex",
                            name: "sex",
                            hiddenName: "user.sex",
                            allowBlank: false,
                            blankText: "不能为空，请填写",
                            valueField: "value",
                            displayField: "label",
                            mode: 'remote',
                            forceSelection: true,
                            emptyText: "请选择...",
                            triggerAction: 'all',
                            width: 70,
                            store: store_sex,
                            listeners: {
                                select: function (combo, record, index) {

                                },
                                render: function (comb, record, index) {

                                }
                            }
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "手机",
                            id: "mobile",
                            name: "user.mobile",
                            value: json.mobile,
                            width: 201
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "固定电话",
                            id: "phone",
                            name: "user.phone",
                            value: json.phone,
                            width: 201
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "地址",
                            id: "address",
                            name: "user.address",
                            value: json.address,
                            width: 201
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "QQ号码",
                            id: "QQ",
                            name: "user.QQ",
                            value: json.QQ,
                            width: 201
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "邮箱地址",
                            id: "mail",
                            name: "user.mail",
                            value: json.mail,
                            width: 201
                        }
                    ]
                });
                store_sex.on("load", function () {
                    comb = Ext.getCmp("sex");
                    comb.setValue(json.sex);
                });
                store_status.on("load", function () {
                    comb = Ext.getCmp("status");
                    comb.setValue(json.status);
                });
                store_status.load();
                store_sex.load();
                var win = new Ext.Window
                ({
                    title: "编辑窗口",
                    autoHeight: true,
                    width: 300,
                    resizable: false,
                    buttonAlign: "center",
                    modal: true,//height:300,
                    items: [p],
                    bbar: [
                        {
                            xtype: "button",
                            text: "确定",
                            iconCls: "accept",
                            handler: function () {
                                //表单提交
                                save(p, win,"edit");
                            }
                        },
                        '', '',
                        {
                            xtype: "button",
                            text: "关闭",
                            iconCls: "cancel",
                            handler: function () {
                                win.destroy();
                            }
                        }
                    ]
                });
                win.show();
            }

//////////////////////添加界面//////////////////////////////////////////
            function add() {
                var p = new Ext.FormPanel
                ({
                    frame: true,
                    labelWidth: 12 * 5,
                    items: [
                        {
                            xtype: "hidden",
                            id: "op",
                            name: "op",
                            width: 201,
                            value: "add"
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "登录ID",
                            id: "username",
                            name: "user.username",
                            allowBlank: false,
                            blankText: "不能为空，请填写",
                            width: 201
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "密码",
                            id: "password",
                            name: "user.password",
                            allowBlank: false,
                            blankText: "不能为空，请填写",
                            width: 201
                        },
                        {
                            xtype: "combo",
                            fieldLabel: "状态",
                            id: "status",
                            hiddenName: "user.status",
                            name: "status",
                            allowBlank: false,
                            blankText: "不能为空，请填写",
                            valueField: "value",
                            displayField: "label",
                            emptyText: "请选择...",
                            mode: 'remote',
                            forceSelection: true,
                            triggerAction: 'all',
                            width: 70,
                            store: store_status
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "姓名",
                            id: "userRealName",
                            name: "user.userRealName",
                            allowBlank: false,
                            minLength: 2,
                            maxlength: 5,
                            width: 201
                        },
                        {
                            xtype: "combo",
                            fieldLabel: "性别",
                            id: "sex",
                            name: "sex",
                            hiddenName: "user.sex",
                            allowBlank: false,
                            blankText: "不能为空，请填写",
                            valueField: "value",
                            displayField: "label",
                            emptyText: "请选择...",
                            mode: 'remote',
                            forceSelection: true,
                            triggerAction: 'all',
                            width: 70,
                            store: store_sex
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "手机",
                            id: "mobile",
                            name: "user.mobile",
                            width: 201
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "固定电话",
                            id: "phone",
                            name: "user.phone",
                            width: 201
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "地址",
                            id: "address",
                            name: "user.address",
                            width: 201
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "QQ号码",
                            id: "QQ",
                            name: "user.QQ",
                            width: 201
                        },
                        {
                            xtype: "textfield",
                            fieldLabel: "邮箱地址",
                            id: "mail",
                            name: "user.mail",
                            width: 201
                        }
                    ]
                });

                var win = new Ext.Window
                ({
                    title: "新增窗口",
                    autoHeight: true,
                    width: 300,
                    resizable: false,
                    buttonAlign: "center",
                    modal: true,//height:300,
                    items: [p],
                    bbar: [
                        {
                            xtype: "button",
                            text: "确定",
                            iconCls: "accept",
                            handler: function () {
                                //表单提交
                                save(p, win,"add");
                            }
                        },
                        '', '',
                        {
                            xtype: "button",
                            text: "关闭",
                            iconCls: "cancel",
                            handler: function () {
                                win.destroy();
                            }
                        }
                    ]
                });
                win.show();
            }

            function save(aquForm, aquWin,op) {
                //验证合法后使用加载进度条
                if (aquForm.form.isValid()) {
                    //提交到服务器操作
                    aquForm.form.submit({
                        waitMsg: '操作进行中,请稍后...',
                        url: op=="edit"?editUrl:addurl,
                        method: 'post',
                        //提交成功的回调函数
                        success: function (form, action) {
                            if (action.result.errcode == 0) {
                                store_grid.reload();
                                aquWin.destroy();
                            } else {
                                Ext.Msg.alert("", action.result.errmsg);
                            }
                        },
                        //提交失败的回调函数
                        failure: function (form, action) {
                            switch (action.failureType) {
                                case Ext.form.Action.CLIENT_INVALID:
                                    Ext.Msg.alert('错误提示', '表单数据非法请核实后重新输入！');
                                    break;
                                case Ext.form.Action.CONNECT_FAILURE:
                                    Ext.Msg.alert('错误提示', '网络连接异常！');
                                    break;
                                case Ext.form.Action.SERVER_INVALID:
                                    Ext.Msg.alert('错误提示', "您的输入用户信息有误，请核实后重新输入！");
                                    simple.form.reset();
                            }
                            aquWin.destroy();
                        }
                    });
                }
            };
            function query(aquForm) {
                //验证合法后使用加载进度条
                if (aquForm.form.isValid()) {
                    //提交到服务器操作
                    store_grid.baseParams = query_form.form.getValues();
                    aquForm.form.submit({
                        waitMsg: '操作进行中,请稍后...',
                        url: viewUrl,
                        method: 'post',
                        //提交成功的回调函数
                        success: function (form, action) {
                            if (action.result.errcode == 0) {
                                store_grid.loadData(action.result);
                            } else {
                                Ext.Msg.alert("", action.result.errmsg);
                            }
                        },
                        //提交失败的回调函数
                        failure: function (form, action) {
                            switch (action.failureType) {
                                case Ext.form.Action.CLIENT_INVALID:
                                    Ext.Msg.alert('错误提示', '表单数据非法请核实后重新输入！');
                                    break;
                                case Ext.form.Action.CONNECT_FAILURE:
                                    Ext.Msg.alert('错误提示', '网络连接异常！');
                                    break;
                                case Ext.form.Action.SERVER_INVALID:
                                    Ext.Msg.alert('错误提示', "您的输入用户信息有误，请核实后重新输入！");
                                    simple.form.reset();
                            }
                        }
                    });
                }
            };
            function del(){
                var selModel = grid.getSelectionModel();
                if (selModel.hasSelection()) {
                    Ext.Msg.confirm("警告", "确定要删除吗？", function (button) {
                        if (button == "yes") {
                            var selected = grid.getSelectionModel().getSelections();
                            var ids = []; //要删除的id
                            Ext.each(selected, function (item) {
                                ids.push(item.json.id);
                            });
                            loadMarsk.show();
                            Ext.Ajax.request({
                                url: delUrl+'?op=delete&ids=' + ids,
                                //根据id删除节点
                                success: function (request) {
                                    store_grid.reload();
                                    loadMarsk.hide();
                                },
                                failure: function () {
                                    alert("删除失败");
                                    loadMarsk.hide();
                                }
                            });
                        }
                    });
                }
                else {
                    Ext.Msg.alert("错误", "没有任何行被选中，无法进行删除操作！");
                }
            }
        });
    </script>
</head>
<body>
<div id="content" style="width: 100%;height: 100%"></div>
</body>
</html>